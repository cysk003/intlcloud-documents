본문은 TencentDB for MySQL 데이터베이스 프록시의 순간 연결 끊김 방지 기능에 대해 설명합니다.

## 배경 정보
인스턴스 작업 중에 구성 수정, 계획된 HA 전환 및 계획된 다시 시작과 같은 일부 조정이 필요할 수 있습니다. 이러한 작업은 세션 중단, 순간 연결 끊김 및 새 연결 실패와 같은 문제를 일으킬 수 있습니다. TencentDB for MySQL 데이터베이스 프록시는 연결 끊김 및 트랜잭션 중단을 방지하기 위해 무손실 애플리케이션 연속성을 가능하게 하는 순간 연결 끊김 방지 기능을 제공합니다.

## 구현 원리
순간 연결 끊김 방지 기능은 MySQL의 session track 메커니즘을 구현합니다. 손실 동작이 감지되면 데이터베이스 프록시는 전환 전에 소스 노드에서 클라이언트 연결을 끊고 전환 후에 소스 노드에 연결합니다. 그 다음 세션 관련 시스템 변수, 사용자 변수 및 문자 세트 인코딩 정보는 session track 메커니즘을 통해 새로운 백엔드 연결로 전송되어 애플리케이션 측에서 무손실 전환을 구현합니다.
![](https://qcloudimg.tencent-cloud.cn/raw/119f026774de441b00adfa1ab265082d.png)

## 주의 사항
- 문이 각 세션과 관련된 임시 테이블을 사용하는 경우 연결을 복구할 수 없으며 오류가 보고됩니다.
- 순간 연결 끊김 방지 기능을 사용하려면 데이터베이스 프록시 커널 버전을 v1.3.1 이상으로 업그레이드해야 합니다.
- 순간 연결 끊김 방지 기능은 3초 이상 트랜잭션을 정지시킵니다.
- 연결 전환 시 데이터베이스 프록시가 데이터베이스에서 결과 메시지를 수신하는 경우 원본/복제본 전환으로 인해 데이터의 일부만 전송되고 순간 연결 끊김 방지 기능이 비활성화됩니다.

## 성능 테스트
Tencent DB for MySQL 데이터베이스 프록시에 대한 순간 연결 끊김 방지 기능의 성능 테스트는 다음과 같습니다.

### 테스트 환경
- 리전/AZ: 베이징 - 베이징 7존.
- 클라이언트: S5.8XLARGE64(표준형 S5, 32코어 64GB).
- 클라이언트 운영 체제: CentOS 8.2 64비트.
- 네트워크: CVM과 TencentDB for MySQL 인스턴스는 모두 동일한 VPC 서브넷에 있습니다.

테스트한 TencentDB for MySQL 인스턴스의 정보는 다음과 같습니다.
- 스토리지 유형: 로컬 SSD 디스크.
- 인스턴스 유형: 일반.
- 매개변수 템플릿: 고성능 템플릿.

### 테스트 툴
성능 테스트를 위한 도구인 sysbench는 고부하 데이터베이스를 실행하는 시스템에 중요한 OS 매개변수를 평가하기 위한 모듈식, 교차 플랫폼 및 멀티 스레드 벤치마크 툴입니다. 복잡한 데이터베이스 벤치마크를 설정하지 않거나 데이터베이스를 전혀 설치하지 않고도 시스템 성능을 신속하게 파악할 수 있습니다.

### 테스트 방법
다른 운영 시나리오에서 데이터베이스 프록시가 고가용성 MySQL 인스턴스에 대한 순간 연결 끊김 방지 기능 제공 여부를 테스트하기 위해 작업 전후의 순간 연결 해제 비율을 분석할 수 있습니다.

## 테스트 결과
다음 운영 시나리오에서 고가용성 MySQL 인스턴스는 데이터베이스 프록시의 순간 연결 끊김 방지 기능에 의해 100% 연결 유지율을 유지합니다.

| 운영 시나리오 | 유지율 |
|---------|---------|
| 원본/복제본 전환 수행 | 100% |
| 커널 마이너 버전 업그레이드 | 100% |
| 인스턴스 사양 조정 | 100% |

